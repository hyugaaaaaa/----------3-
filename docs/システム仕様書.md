# 在庫登録スキャナーシステム 仕様書

**バージョン**: 1.0  
**作成日**: 2026-02-03  
**プロジェクト名**: POSIC (Point of Stock Inventory Control)

---

## 1. システム概要

### 1.1 目的
スマートフォンでQRコード/バーコードをスキャンし、商品の在庫数を簡単に登録できるWebアプリケーション。

### 1.2 主要機能
- QRコード/バーコードスキャン
- 商品情報の自動取得
- 理論在庫の自動計算・表示
- 実在庫の登録
- 登録履歴の表示

### 1.3 技術スタック
- **フロントエンド**: HTML5, CSS3, JavaScript
- **バックエンド**: PHP 7.4+
- **データベース**: MySQL 5.7+
- **ライブラリ**: html5-qrcode (QRコードスキャン)
- **サーバー**: Apache (XAMPP)

---

## 2. システム構成

### 2.1 ディレクトリ構造

```
posic/
├── index.html              # メインUI
├── html5-qrcode.min.js     # QRコードライブラリ
├── db_config.php           # DB接続設定
├── setup.sql               # テーブル定義
├── scan_debug.log          # スキャンログ
├── api/
│   ├── scan.php           # 商品検索API
│   └── register.php       # 在庫登録API
├── classes/
│   ├── Product.php        # 商品クラス
│   ├── Inventory.php      # 在庫クラス
│   └── ScanLogger.php     # ログクラス
└── docs/
    └── (各種ドキュメント)
```

### 2.2 アクセスURL
- **PC**: `http://localhost/posic/`
- **スマートフォン**: `http://[PCのIPアドレス]/posic/`
  - 例: `http://192.168.1.15/posic/`

---

## 3. データベース設計

### 3.1 データベース名
`stock_management`

### 3.2 テーブル一覧

#### 3.2.1 M_商品マスタ
商品の基本情報を管理

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| 商品ID | INT | PK, AUTO_INCREMENT | 商品の一意識別子 |
| 商品コード | VARCHAR(20) | NOT NULL | QRコード/バーコード |
| 商品名 | VARCHAR(256) | NOT NULL | 商品名称 |
| カテゴリ | INT | NOT NULL | カテゴリID |
| 登録者 | INT | NOT NULL | 登録ユーザーID |
| 登録日時 | DATETIME | NOT NULL | 登録日時 |
| 更新者 | INT | NOT NULL | 更新ユーザーID |
| 更新日時 | DATETIME | NOT NULL | 更新日時 |

#### 3.2.2 T_入出庫履歴
入庫・出庫の履歴を管理

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| 履歴ID | INT | PK, AUTO_INCREMENT | 履歴の一意識別子 |
| 対象年月 | INT | NOT NULL | YYYYMM形式 |
| 倉庫ID | INT | NOT NULL | 倉庫ID |
| 棚ID | INT | NOT NULL | 棚ID |
| 商品ID | INT | NOT NULL | 商品ID |
| 区分 | INT | NOT NULL | 1:入庫, 2:出庫 |
| 数量 | INT | NOT NULL | 入出庫数量 |
| 備考 | VARCHAR(100) | NULL | 備考 |
| 削除フラグ | TINYINT(1) | NULL | 0:有効, 1:削除 |
| 登録者 | INT | NOT NULL | 登録ユーザーID |
| 登録日時 | DATETIME | NOT NULL | 登録日時 |
| 更新者 | INT | NOT NULL | 更新ユーザーID |
| 更新日時 | DATETIME | NOT NULL | 更新日時 |

#### 3.2.3 T_棚卸履歴
棚卸の結果を管理

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| 棚卸ID | INT | PK, AUTO_INCREMENT | 棚卸の一意識別子 |
| 年月 | INT | NOT NULL | YYYYMM形式 |
| 棚卸日 | DATE | NOT NULL | 棚卸実施日 |
| 倉庫ID | INT | NOT NULL | 倉庫ID |
| 棚ID | INT | NOT NULL | 棚ID |
| 商品ID | INT | NOT NULL | 商品ID |
| 理論在庫 | INT | NOT NULL | システム計算値 |
| 実在庫 | INT | NOT NULL | 実際の在庫数 |
| 差異 | INT | NOT NULL | 実在庫 - 理論在庫 |
| 確定フラグ | TINYINT(1) | NULL | 確定済みフラグ |
| 確定日時 | DATETIME | NULL | 確定日時 |
| 登録者 | INT | NOT NULL | 登録ユーザーID |
| 登録日時 | DATETIME | NOT NULL | 登録日時 |
| 更新者 | INT | NOT NULL | 更新ユーザーID |
| 更新日時 | DATETIME | NOT NULL | 更新日時 |

#### 3.2.4 その他のマスタテーブル
- `M_倉庫マスタ`: 倉庫情報
- `M_棚マスタ`: 棚情報
- `M_ユーザーマスタ`: ユーザー情報
- `M_汎用コードマスタ`: 汎用コード
- `T_月次在庫`: 月次在庫集計

---

## 4. API仕様

### 4.1 商品検索API

**エンドポイント**: `GET /api/scan.php`

**パラメータ**:
| パラメータ名 | 型 | 必須 | 説明 |
|------------|-----|------|------|
| code | string | ✓ | 商品コード(QRコード/バーコード) |

**レスポンス例**:
```json
{
  "success": true,
  "message": "商品が見つかりました",
  "data": {
    "id": 17,
    "code": "00030027",
    "name": "速乾インク C8842A",
    "price": 0,
    "stock": 340
  }
}
```

**エラーレスポンス例**:
```json
{
  "success": false,
  "message": "未登録の商品です",
  "data": {
    "code": "00000000"
  }
}
```

### 4.2 在庫登録API

**エンドポイント**: `POST /api/register.php`

**リクエストボディ**:
```json
{
  "product_id": 17,
  "actual_stock": 350
}
```

**レスポンス例**:
```json
{
  "success": true,
  "message": "在庫登録が完了しました",
  "data": {
    "inventory_id": 5
  }
}
```

**エラーレスポンス例**:
```json
{
  "success": false,
  "message": "Required parameters are missing."
}
```

---

## 5. 画面仕様

### 5.1 メイン画面 (index.html)

#### 5.1.1 QRコードスキャナー
- カメラを起動してQRコード/バーコードを読み取り
- ズーム機能対応(対応デバイスのみ)
- 背面カメラを使用

#### 5.1.2 スキャン結果表示
- 商品名
- 商品コード
- 理論在庫数

#### 5.1.3 実在庫入力
- 数値入力フィールド
- デフォルト値: 理論在庫数
- 確認ボタン / キャンセルボタン

#### 5.1.4 確認モーダル
- 商品名
- 理論在庫
- 実在庫
- 判定(多い/少ない/一致)
- 登録ボタン / 戻るボタン

#### 5.1.5 登録履歴
- カード形式で表示
- 各カードの内容:
  - 登録時刻
  - 商品名
  - 実在庫数
  - 判定バッジ
- 左ボーダーで判定を色分け:
  - 緑: 一致
  - 赤: 多い
  - オレンジ: 少ない

---

## 6. ビジネスロジック

### 6.1 理論在庫の計算

**計算式**:
```
理論在庫 = Σ(入庫数量) - Σ(出庫数量)
```

**実装**:
- `Inventory::getTheoreticalStock($productId)`
- `T_入出庫履歴`テーブルから集計
- 区分が1(入庫)の数量を合計
- 区分が2(出庫)の数量を合計
- 差分を計算

### 6.2 棚卸登録処理

**処理フロー**:
1. 理論在庫を再計算
2. 差異を計算 (実在庫 - 理論在庫)
3. `T_棚卸履歴`に登録
   - 年月: 現在の年月(YYYYMM)
   - 棚卸日: 現在の日付
   - 倉庫ID: 1 (固定)
   - 棚ID: 1 (固定)
   - 確定フラグ: 1 (即確定)

---

## 7. 運用仕様

### 7.1 デフォルト値
- **倉庫ID**: 1
- **棚ID**: 1
- **ユーザーID**: 1

### 7.2 ログ
- **ファイル**: `scan_debug.log`
- **記録内容**: スキャン日時、商品コード、結果

### 7.3 エラーハンドリング
- 商品未登録: 「未登録の商品です」メッセージ表示
- 通信エラー: 「通信エラー」メッセージ表示
- 登録エラー: エラーメッセージをアラート表示

---

## 8. セキュリティ

### 8.1 SQLインジェクション対策
- PDOのプリペアドステートメント使用
- `bindValue`でパラメータバインド

### 8.2 XSS対策
- `htmlspecialchars`で入力値をエスケープ

### 8.3 HTTPメソッド制限
- 登録APIはPOSTメソッドのみ許可

---

## 9. 制約事項

### 9.1 現在の制約
- 倉庫・棚は固定値(ID=1)
- ユーザー認証なし
- 価格情報なし
- オフライン動作非対応

### 9.2 ブラウザ要件
- カメラアクセス可能なモダンブラウザ
- JavaScript有効
- HTTPS推奨(カメラアクセスのため)

---

## 10. 今後の拡張予定

- [ ] 倉庫・棚の選択機能
- [ ] ユーザー認証機能
- [ ] 価格情報の追加
- [ ] レポート機能
- [ ] オフライン対応(PWA化)
- [ ] 複数商品の一括登録
- [ ] 在庫アラート機能

---

## 11. 変更履歴

| 日付 | バージョン | 変更内容 |
|------|----------|---------|
| 2026-02-03 | 1.0 | 初版作成 |
